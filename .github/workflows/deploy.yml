name: Deploy coupon-service (Docker Compose on EC2)

on:
  push:
    branches: ["main"]

env:
  IMAGE_NAME: coupon-service

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) 소스 가져오기
      - name: Checkout
        uses: actions/checkout@v4

      # 2) (선택) 자바/그레이들 빌드
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Build (Gradle)
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      # 3) 도커허브 로그인 (Secrets 필요)
      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4) 이미지 빌드 & 푸시 (태그는 커밋 해시 7자리 + latest)
      - name: Build & Push
        run: |
          TAG=$(echo "${GITHUB_SHA}" | cut -c1-7)
          IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}

          docker build -t $IMAGE:$TAG .
          docker push $IMAGE:$TAG

          docker tag $IMAGE:$TAG $IMAGE:latest
          docker push $IMAGE:latest

      # 5) EC2에 SSH로 들어가서 compose pull/up (배포)
      - name: Deploy via SSH (docker compose)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}     # 보통 ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            cd /opt/coupon

            # ✅ 최신 이미지 pull
            docker compose pull

            # ✅ 컨테이너 재기동(무중단에 가까운 재시작은 별도 전략 필요)
            docker compose up -d

            # ✅ 상태 확인
            docker compose ps
            docker logs --tail=50 coupon-service